<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.java501.S20230401.model.dgReplyMapper">

	<resultMap type="Reply" id="dgReplyMap">
		<id 	column="art_id" 		property="art_id"/>
		<id 	column="brd_id" 		property="brd_id"/>
		<id 	column="rep_id" 		property="rep_id"/>
		<result column="mem_id" 		property="mem_id"/>
		<result column="rep_content" 	property="rep_content"/>
		<result column="rep_regdate" 	property="rep_regdate"/>
		<result column="rep_good" 		property="rep_good"/>
		<result column="rep_bad" 		property="rep_bad"/>
		<result column="rep_parent" 	property="rep_parent"/>
		<result column="rep_step" 		property="rep_step"/>
		<result column="isdelete" 		property="isdelete"/>
		<result column="report_id" 		property="report_id"/>
		<collection property="member" 	resultMap="com.java501.S20230401.model.dgMemberMapper.dgMemberMap"/>
		<collection property="board" 	resultMap="com.java501.S20230401.model.dgBoardMapper.dgBoardMap"/>
	</resultMap>
	
	<!-- 댓글 조회 -->
	<select id="gdReplyList" parameterType="Article" resultMap="dgReplyMap">
		SELECT  *
		FROM   (SELECT  ROWNUM RN, J.*
		        FROM   (SELECT  R.*, M.MEM_USERNAME, M.MEM_NICKNAME, M.MEM_EMAIL, M.MEM_AUTHORITY, M.MEM_IMAGE, M.MEM_LATEST
		                FROM    REPLY R, MEMBER M
		                WHERE   R.MEM_ID = M.MEM_ID(+))J
				WHERE ART_ID = #{art_id} AND BRD_ID = #{brd_id}
		        ORDER BY J.REP_PARENT ASC, REP_ID ASC
		        )
	</select>
	
	<!-- 댓글 작성  -->
	<insert id="dgWriteReply" parameterType="Reply">
		INSERT 
		INTO    REPLY(ART_ID, BRD_ID, REP_ID, MEM_ID, REP_CONTENT, REP_REGDATE, REP_GOOD, REP_BAD, REP_PARENT, REP_STEP, ISDELETE)
		VALUES (#{art_id},
		        #{brd_id},
		       (SELECT  NVL(MAX(REP_ID),0)+1
		        FROM    REPLY
		        WHERE   ART_ID = #{art_id}
		        AND     BRD_ID = #{brd_id}),
		        #{mem_id},
		        #{rep_content},
		        SYSDATE,
		        0,
		        0,
		        <choose>
		        	<when test="rep_parent != null">
		        		#{rep_parent}, 
		        	</when>
		        	<otherwise>
		        		(SELECT  NVL(MAX(REP_ID),0)+1
				         FROM    REPLY
				         WHERE   ART_ID = #{art_id}
				         AND     BRD_ID = #{brd_id}),
		        	</otherwise>
		        </choose>
		        <choose>
		        	<when test="rep_step != null">
		        		#{rep_step}+1,
		        	</when>
		        	<otherwise>
		        		0,
		        	</otherwise>
		        </choose>
		        0)
	</insert>
</mapper>