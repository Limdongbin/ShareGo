<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.java501.S20230401.ReplyMapper">
	<select id="hgGetReplyByArticle" parameterType="Article" resultType="ReplyMember">
		<!-- SELECT *
		FROM (SELECT * FROM REPLY
			  START WITH REP_ID = REP_PARENT
			  CONNECT BY PRIOR REP_ID = REP_PARENT
			  ORDER SIBLINGS BY REP_REGDATE ASC
			 ) R LEFT OUTER JOIN MEMBER M ON (R.MEM_ID = M.MEM_ID)
		WHERE R.ART_ID = #{art_id} AND R.BRD_ID = #{brd_id} -->
		<!-- 
			R.ART_ID, R.BRD_ID, R.REP_ID, R.MEM_ID, R.REP_CONTENT, R.REP_REGDATE,
			R.REP_GOOD, R.REP_BAD, R.REP_PARENT, R.REP_STEP, R.ISDELETE, R.REPORT_ID,
			M.MEM_USERNAME, M.MEM_NICKNAME, M.MEM_IMAGE
		 -->
		SELECT *
		FROM (SELECT DISTINCT R.*, M.MEM_NICKNAME, M.MEM_IMAGE FROM REPLY R LEFT OUTER JOIN MEMBER M ON (R.MEM_ID = M.MEM_ID)
				 WHERE ART_ID = #{art_id} AND BRD_ID = #{brd_id} AND R.ISDELETE = 0
				 START WITH REP_ID = REP_PARENT
				 CONNECT BY PRIOR REP_ID = REP_PARENT AND REP_ID != REP_PARENT
				 ORDER SIBLINGS BY REP_PARENT ASC, REP_REGDATE ASC
			 )
	</select>
	<insert id="hgInsertReply" parameterType="Reply">
		INSERT INTO REPLY (ART_ID, BRD_ID, REP_ID, MEM_ID, REP_CONTENT, REP_REGDATE,
						   REP_GOOD, REP_BAD, REP_PARENT, REP_STEP, ISDELETE)
		VALUES (#{art_id}, #{brd_id}, (SELECT NVL(MAX(REP_ID), 0) + 1 FROM REPLY
									  WHERE ART_ID = #{art_id} AND BRD_ID = #{brd_id}),
				#{mem_id}, #{rep_content, jdbcType=VARCHAR}, SYSDATE,
				0, 0,
				<choose>
					<when test="rep_parent == null">
						(SELECT NVL(MAX(REP_ID), 0) + 1 FROM REPLY
						 WHERE ART_ID = #{art_id} AND BRD_ID = #{brd_id}),
					</when>
					<otherwise>
						#{rep_parent},
					</otherwise>
				</choose>
				<choose>
					<when test="rep_parent == null">
						1,
					</when>
					<otherwise>
						(SELECT NVL(MAX(REP_STEP), 0) + 1 FROM REPLY
						 WHERE ART_ID = #{art_id} AND BRD_ID = #{brd_id}
						 	   AND REP_PARENT = #{rep_parent}),
					</otherwise>
				</choose>
				0)
	</insert>
</mapper>