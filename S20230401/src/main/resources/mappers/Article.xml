<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.java501.S20230401.ArticleMapper">
	<insert id="hgInsertArticle" parameterType="Article">
		<!-- INSERT INTO ARTICLE (ART_ID, BRD_ID, ART_TITLE, MEM_ID, ART_REGDATE, ART_CONTENT,
							 ART_TAG1, ART_TAG2, ART_TAG3, ART_TAG4, ART_TAG5, TRD_ID, ART_GOOD,
							 ART_BAD, ART_READ, ART_ISNOTICE, ISDELETE, REPORT_ID)
		VALUES ((SELECT MAX(ART_ID) + 1 FROM ARTICLE WHERE BRD_ID = #{brd_id}), #{brd_id},
				#{art_title, jdbcType=VARCHAR}, #{mem_id}, SYSDATE, #{art_content, jdbcType=VARCHAR},
				#{art_tag1, jdbcType=VARCHAR}, #{art_tag2, jdbcType=VARCHAR}, #{art_tag3, jdbcType=VARCHAR},
				#{art_tag4, jdbcType=VARCHAR}, #{art_tag5, jdbcType=VARCHAR}, #{trd_id, jdbcType=NUMERIC},
				0, 0, 0, 0, 0, NULL) -->
		INSERT INTO ARTICLE (ART_ID, BRD_ID, ART_TITLE, MEM_ID, ART_REGDATE, ART_CONTENT,
							 ART_TAG1, ART_TAG2, ART_TAG3, ART_TAG4, ART_TAG5, TRD_ID, ART_GOOD,
							 ART_BAD, ART_READ, ART_ISNOTICE, ISDELETE, REPORT_ID)
		VALUES ((SELECT MAX(ART_ID) + 1 FROM ARTICLE WHERE BRD_ID = #{brd_id}), #{brd_id},
				#{art_title, jdbcType=VARCHAR}, #{mem_id}, SYSDATE, #{art_content, jdbcType=VARCHAR},
				#{art_tag1, jdbcType=VARCHAR}, #{art_tag2, jdbcType=VARCHAR}, #{art_tag3, jdbcType=VARCHAR},
				#{art_tag4, jdbcType=VARCHAR}, #{art_tag5, jdbcType=VARCHAR}, NULL,
				0, 0, 0, 0, 0, NULL)
	</insert>
	<select id="hgGetArticleById" parameterType="Article" resultType="Article">
		SELECT * FROM ARTICLE
		WHERE ART_ID = #{art_id} AND BRD_ID = #{brd_id}
	</select>


	<!-- 여기서부터 내꺼 -->
	
	<select id="ArticleTotalCnt" resultType="int">
		select 	Count(*) 
		FROM   	article 
		WHERE  	brd_id between 1010 and 1060
		AND    	isdelete = 0
	</select>

	<select id="ArticleBoardCnt" parameterType="Article"
		resultType="int">
		SELECT 	Count(*) 
		FROM 	article 
		WHERE 	brd_id=#{brd_id}
		AND 	isdelete = 0
	</select>


	<select id="tkArticleListAll" parameterType="Article" resultType="Article">
		SELECT * FROM (
		    SELECT ROWNUM RN, TT.*
		    FROM (
		           SELECT   A.ART_ID
		           		  , A.BRD_ID
		           		  , A.ART_TITLE
		           		  , A.MEM_ID
		           		  , A.ART_REGDATE
		           		  , A.ART_CONTENT
		           		  , A.ART_TAG1
		           		  , A.ART_TAG2
		           		  , A.ART_TAG3
		           		  , A.ART_TAG4
		           		  , A.ART_TAG5
		           		  , A.TRD_ID
		           		  , A.ART_GOOD
		           		  , A.ART_BAD
		           		  , A.ART_READ
		           		  , A.ART_ISNOTICE
		           		  , A.ISDELETE
		           		  , A.REPORT_ID
		           		  , M.MEM_USERNAME
		           		  , M.MEM_PASSWORD
		           		  , M.MEM_NICKNAME
		           		  , M.MEM_EMAIL
		           		  , M.MEM_TEL
		           		  , M.MEM_REGION1
		           		  , M.MEM_REGION2
		           		  , M.MEM_AUTHORITY
		           		  , M.MEM_REGDATE
		           		  , M.MEM_IMAGE
		           		  , M.MEM_GENDER
		           		  , M.MEM_NAME
		           		  , M.MEM_BIRTHDAY
		           		  , M.MEM_LATEST
		           		  , C1.COMM_ID 		as C1_COMM_ID
		           		  , C1.COMM_VALUE   as C1_COMM_VALUE
		           		  , C2.COMM_ID      as C2_COMM_ID
		           		  , C2.COMM_VALUE   as C2_COMM_VALUE
		           		  , R.REG_ID
		           		  , R.REG_NAME
		           		  , R.REG_PARENT
		           		  , T.TRD_STATUS
		           		  , T.TRD_MAX
		           		  , T.TRD_ENDDATE
		           		  , T.TRD_COST
		           		  , T.TRD_LOC
		           		  , T.TRD_GENDER
		           		  , T.TRD_MINAGE
		           		  , T.TRD_MAXAGE
		           		  , TRUNC(SYSDATE - A.ART_REGDATE) 			AS REST_REGDATE
		           		  , TO_CHAR(T.TRD_ENDDATE, 'YYYY-MM-DD') 	AS TRD_FINISH
		           		  , favorite_count(a.art_id, a.brd_id) 		AS favoriteCount
		           		  , reply_count(a.art_id, a.brd_id)			AS repCount
		            FROM ARTICLE A LEFT OUTER JOIN TRADE T ON(A.TRD_ID = T.TRD_ID)
		                           LEFT OUTER JOIN MEMBER M ON(A.MEM_ID = M.MEM_ID)
		                           LEFT OUTER JOIN COMM C1 ON(T.TRD_STATUS = C1.COMM_ID)
		                           LEFT OUTER JOIN COMM C2 ON(T.TRD_GENDER = C2.COMM_ID)
		                           LEFT OUTER JOIN REGION R ON(T.REG_ID = R.REG_ID)
		        	WHERE A.BRD_ID BETWEEN 1010 AND 1060
		            AND A.ISDELETE = 0
		        	ORDER BY A.ART_REGDATE DESC) TT)
		WHERE RN BETWEEN #{start} AND #{end}
			
	</select>

	<select id="tkArticleListBoard" parameterType="Article" resultType="Article">
		SELECT * FROM (
		    SELECT ROWNUM RN, TT.*
		    FROM (
		           SELECT   A.ART_ID
		           		  , A.BRD_ID
		           		  , A.ART_TITLE
		           		  , A.MEM_ID
		           		  , A.ART_REGDATE
		           		  , A.ART_CONTENT
		           		  , A.ART_TAG1
		           		  , A.ART_TAG2
		           		  , A.ART_TAG3
		           		  , A.ART_TAG4
		           		  , A.ART_TAG5
		           		  , A.TRD_ID
		           		  , A.ART_GOOD
		           		  , A.ART_BAD
		           		  , A.ART_READ
		           		  , A.ART_ISNOTICE
		           		  , A.ISDELETE
		           		  , A.REPORT_ID
		           		  , M.MEM_USERNAME
		           		  , M.MEM_PASSWORD
		           		  , M.MEM_NICKNAME
		           		  , M.MEM_EMAIL
		           		  , M.MEM_TEL
		           		  , M.MEM_REGION1
		           		  , M.MEM_REGION2
		           		  , M.MEM_AUTHORITY
		           		  , M.MEM_REGDATE
		           		  , M.MEM_IMAGE
		           		  , M.MEM_GENDER
		           		  , M.MEM_NAME
		           		  , M.MEM_BIRTHDAY
		           		  , M.MEM_LATEST
		           		  , C1.COMM_ID 		as C1_COMM_ID
		           		  , C1.COMM_VALUE   as C1_COMM_VALUE
		           		  , C2.COMM_ID      as C2_COMM_ID
		           		  , C2.COMM_VALUE   as C2_COMM_VALUE
		           		  , R.REG_ID
		           		  , R.REG_NAME
		           		  , R.REG_PARENT
		           		  , T.TRD_STATUS
		           		  , T.TRD_MAX
		           		  , T.TRD_ENDDATE
		           		  , T.TRD_COST
		           		  , T.TRD_LOC
		           		  , T.TRD_GENDER
		           		  , T.TRD_MINAGE
		           		  , T.TRD_MAXAGE
		           		  , TRUNC(SYSDATE - A.ART_REGDATE) AS REST_REGDATE
		           		  , TO_CHAR(T.TRD_ENDDATE, 'YYYY-MM-DD') 	AS TRD_FINISH
		           		  , favorite_count(a.art_id, a.brd_id) 		AS favoriteCount
		           		  , reply_count(a.art_id, a.brd_id)			AS repCount
		            FROM ARTICLE A LEFT OUTER JOIN TRADE T ON(A.TRD_ID = T.TRD_ID)
		                           LEFT OUTER JOIN MEMBER M ON(A.MEM_ID = M.MEM_ID)
		                           LEFT OUTER JOIN COMM C1 ON(T.TRD_STATUS = C1.COMM_ID)
		                           LEFT OUTER JOIN COMM C2 ON(T.TRD_GENDER = C2.COMM_ID)
		                           LEFT OUTER JOIN REGION R ON(T.REG_ID = R.REG_ID)
		        	WHERE A.BRD_ID = #{brd_id}
		            AND A.ISDELETE = 0
		        	ORDER BY A.ART_REGDATE DESC) TT)
		WHERE RN BETWEEN #{start} AND #{end}
	</select>


	<select id="tkArticleDetail" parameterType="Article" resultType="Article">
        SELECT  		  a.*
        				, m.*
        				, r.*
        				, reply_count(A.ART_ID, A.BRD_ID)   	AS repCount
        		   		, t.trd_id
        		   		, t.trd_status
        		   		, t.trd_max
        		   		, trunc(sysdate - a.art_regdate)    	AS rest_regdate
            	   		, t.trd_cost
            	   		, t.trd_loc
            	   		, t.trd_gender
            	   		, t.trd_enddate
            	   		, t.trd_minage
            	   		, t.trd_maxage
            	   		, C1.COMM_ID 							AS C1_COMM_ID
		           		, C1.COMM_VALUE   						AS C1_COMM_VALUE
		           		, C2.COMM_ID      						AS C2_COMM_ID
		           		, C2.COMM_VALUE   						AS C2_COMM_VALUE
            	   		, to_char(t.trd_enddate, 'YYYY-MM-DD') 	AS trd_finish
            	   		, favorite_count(a.art_id, a.brd_id) 	AS favoriteCount
        FROM    	article a 		LEFT JOIN trade  t 	ON (A.TRD_ID = T.TRD_ID)
                          			LEFT JOIN member m  ON (a.mem_id = m.mem_id)
		                            LEFT OUTER JOIN COMM C1 ON(T.TRD_STATUS = C1.COMM_ID)
		                            LEFT OUTER JOIN COMM C2 ON(T.TRD_GENDER = C2.COMM_ID)
                          			LEFT JOIN REGION R  ON(t.reg_id = r.reg_id)
        WHERE 		a.brd_id = #{brd_id}
		AND 		a.art_id = #{art_id}
		AND			a.isdelete = 0
        ORDER BY 	a.brd_id
	</select>
	
<!-- 	<select id="tkFavoriteCount" parameterType="Article" resultType="int">
		select      count(*)
		from        favorite f left Join article a on(a.art_id = f.art_id and a.brd_id = f.brd_id)
                       		   left join member  m on(f.mem_id = m.mem_id)
        where		a.art_id = #{art_id}
		and			a.brd_id = #{brd_id}
		group by    a.art_id, a.brd_id
	</select> -->

	<select id="tkReplyList" parameterType="Article" resultType="Article">
		SELECT        r.*
					, a.*
					, m.*
		FROM        reply r LEFT JOIN article a ON(a.art_id = r.art_id  and a.brd_id = r.brd_id)
                    		LEFT JOIN member  m ON(r.mem_id = m.mem_id)
		WHERE 		a.brd_id = #{brd_id}
		AND   		a.art_id = #{art_id}
		AND			r.isdelete = 0
	</select>
	
	<select id = "insertArticle" statementType="CALLABLE" parameterType="Article">
		{
		call Insert_Article(
			1
			, 401
			, #{trd_max,       mode= IN,  jdbcType=NUMERIC}
			, #{trd_enddate,   mode= IN,  jdbcType=DATE}
			, #{trd_cost,      mode= IN,  jdbcType=NUMERIC}
			, #{reg_id,        mode= IN,  jdbcType=NUMERIC}
			, #{trd_loc,       mode= IN,  jdbcType=VARCHAR}
			, #{trd_gender,    mode= IN,  jdbcType=NUMERIC}
			, #{trd_minage,    mode= IN,  jdbcType=NUMERIC}
			, #{trd_maxage,    mode= IN,  jdbcType=NUMERIC} 
			, #{brd_id,        mode= IN,  jdbcType=NUMERIC}
			, #{art_title,     mode= IN,  jdbcType=VARCHAR}
			, #{art_content,   mode= IN,  jdbcType=VARCHAR}
			, #{art_tag1,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag2,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag3,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag4,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag5,      mode= IN,  jdbcType=VARCHAR}
			, #{insert_result, mode= OUT, jdbcType=NUMERIC})
		}
	</select>
<!-- 	<insert id ="insertTrade" parameterType="Article">
		insert into trade 
				values (trd_id_seq.nextval, 1, '401', #{trd_max}, #{trd_enddate}
				, 0, #{reg_id, jdbcType=NUMERIC}, #{trd_loc, jdbcType=VARCHAR}, #{trd_gender, jdbcType=NUMERIC}
				, #{trd_minage, jdbcType=NUMERIC}, #{trd_maxage, jdbcType=NUMERIC})
			<selectKey resultType="int" keyProperty="trd_id" order="AFTER">
				select trd_id_seq.currval from dual
			</selectKey>
	</insert> -->
	
	<!-- <insert id="insertArticle" parameterType="Article">
		insert into article 
			values ((Select max(art_id) + 1 from article where brd_id = #{brd_id})
            , #{brd_id}, #{art_title}, 1, sysdate, #{art_content, jdbcType=VARCHAR}, #{art_tag1, jdbcType=VARCHAR}, #{art_tag2, jdbcType=VARCHAR}
            , #{art_tag3, jdbcType=VARCHAR}, #{art_tag4, jdbcType=VARCHAR}, #{art_tag5, jdbcType=VARCHAR}, #{trd_id, jdbcType=NUMERIC}
            , 0, 0, 0, 0, 0, null)
	</insert> -->
	
 	<update id="deleteArticle" parameterType="Article">
		UPDATE article
		SET    isdelete = 1
		WHERE  brd_id = #{brd_id} 
		AND    art_id = #{art_id}
	</update>
	
<!-- 
 	<delete id="deleteTrade" parameterType="Article">
		Delete from Trade where trd_id = #{trd_id}
	</delete> -->
<!-- 	<update id= "updateTrade" parameterType="Article">
    	UPDATE 	 trade 
    	SET		 reg_id 		= #{reg_id}
    	   		,trd_loc 		= #{trd_loc}
    	   		,trd_minage 	= #{trd_minage}
    	   		,trd_maxage 	= #{trd_maxage}
    	   		,trd_enddate 	= #{trd_enddate}
    	WHERE 	 trd_id = #{trd_id}
	</update>
	
	<update id="updateArticle" parameterType="Article">
		UPDATE 		article 
		SET			brd_id 		= #{brd_id}
				   ,art_title 	= #{art_title}
				   ,art_content = #{art_content}
				   ,art_tag1 	= #{art_tag1}
				   ,art_tag2 	= #{art_tag2}
				   ,art_tag3 	= #{art_tag3}
				   ,art_tag4 	= #{art_tag4}
				   ,art_tag5 	= #{art_tag5} 
 		WHERE		art_id 		= #{art_id}
 		AND			brd_id 		= #{brd_id}
	</update> -->
	
	<select id="updateArticle" parameterType="Article" statementType="CALLABLE">
	{
		call Update_Article(
			  #{trd_id, 	   mode= IN,  jdbcType=NUMERIC}
			, 1
			, 401
			, #{trd_max,       mode= IN,  jdbcType=NUMERIC}
			, #{trd_enddate,   mode= IN,  jdbcType=DATE}
			, #{trd_cost,      mode= IN,  jdbcType=NUMERIC}
			, #{reg_id,        mode= IN,  jdbcType=NUMERIC}
			, #{trd_loc,       mode= IN,  jdbcType=VARCHAR}
			, #{trd_gender,    mode= IN,  jdbcType=NUMERIC}
			, #{trd_minage,    mode= IN,  jdbcType=NUMERIC}
			, #{trd_maxage,    mode= IN,  jdbcType=NUMERIC}
			, #{art_id,		   mode= IN,  jdbcType=NUMERIC}
			, #{brd_id,        mode= IN,  jdbcType=NUMERIC}
			, #{art_title,     mode= IN,  jdbcType=VARCHAR}
			, #{art_content,   mode= IN,  jdbcType=VARCHAR}
			, #{art_tag1,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag2,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag3,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag4,      mode= IN,  jdbcType=VARCHAR}
			, #{art_tag5,      mode= IN,  jdbcType=VARCHAR}
			, #{insert_result, mode= OUT, jdbcType=NUMERIC})
		}
	</select>

</mapper>