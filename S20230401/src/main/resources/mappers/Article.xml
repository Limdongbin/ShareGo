<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.java501.S20230401.model.dgArticleMapper">
	
	<resultMap type="Article" id="dgArticleMap">
		<id 	column="art_id" 		property="art_id"/> <!-- PK	 -->
		<id 	column="brd_id" 		property="brd_id"/>	<!-- PK -->
		<result column="art_title" 		property="art_title"/>
		<result column="mem_id" 		property="mem_id"/>
		<result column="art_regdate" 	property="art_regdate"/>
		<result column="art_content" 	property="art_content"/>
		<result column="art_tag1" 		property="art_tag1"/>
		<result column="art_tag2" 		property="art_tag2"/>
		<result column="art_tag3" 		property="art_tag3"/>
		<result column="art_tag4" 		property="art_tag4"/>
		<result column="art_tag5" 		property="art_tag5"/>
		<result column="trd_id" 		property="trd_id"/>
		<result column="art_good" 		property="art_good"/>
		<result column="art_bad" 		property="art_bad"/>
		<result column="art_read" 		property="art_read"/>
		<result column="art_isnotice" 	property="art_isnotice"/>
		<result column="isdelete" 		property="isdelete"/>
		<result column="report_id" 		property="report_id"/>
		<result column="gen_name" 		property="gen_name"/>
		<result column="brd_name" 		property="brd_name"/>
		<result column="status_name" 	property="status_name"/>
		<result column="rep_cnt" 		property="rep_cnt"/>
		<collection property="member" 	resultMap="com.java501.S20230401.model.dgMemberMapper.dgMemberMap"/>
		<collection property="board" 	resultMap="com.java501.S20230401.model.dgBoardMapper.dgBoardMap"/>
		<collection property="trade" 	resultMap="com.java501.S20230401.model.dgTradeMapper.dgTradeMap"/>
	</resultMap>
	
		<!-- 게시판 카운트 -->
<!--<select id="dgArtCnt" resultType="int" parameterType="Article">
		<![CDATA[
			SELECT 	COUNT(*)
			FROM 	ARTICLE
			WHERE 	brd_id = #{brd_id}
		]]>
	</select> -->
	
	<!-- 전체 카운트 -->
	<select id="dgAllArtCnt" resultType="int" parameterType="Article">
		Select 	count(*)
		From 	article
		Where 	brd_id 
		<choose>
			<when test="brd_id % 100 != 0">
				= #{brd_id}
			</when>
			<otherwise>
				BETWEEN #{brd_id} and #{brd_id}+99
			</otherwise>
		</choose>
	</select>

	<!-- 전체 조회 -->
	<select id="dgAllArticleList" resultMap="dgArticleMap" parameterType="Article">
		SELECT  *
		FROM    (SELECT ROWNUM AS RN, J.*
		         FROM   (SELECT *
		                 FROM ( SELECT  *
		                        FROM    ARTICLE A
		                        JOIN    (   SELECT  C1.COMM_VALUE AS BRD_NAME, B.*
		                                    FROM    BOARD B JOIN COMM C1
		                                    ON      BRD_ID IN COMM_ID
		                                 )USING(BRD_ID)
		                        JOIN	(   SELECT  C2.COMM_VALUE AS GEN_NAME, M.*
		                                    FROM    MEMBER M JOIN COMM C2
		                                    ON      MEM_GENDER IN COMM_ID
		                                 )USING(MEM_ID)
				                LEFT OUTER JOIN 	(   SELECT  C3.COMM_VALUE AS STATUS_NAME, T.*, R.REG_NAME
				                                        FROM    TRADE T LEFT OUTER JOIN COMM C3
				                                        ON      T.TRD_STATUS = C3.COMM_ID
				                                        LEFT OUTER JOIN REGION R
				                                        ON      T.REG_ID = R.REG_ID
				                         )USING(TRD_ID)
		                        LEFT OUTER JOIN    (    SELECT COUNT(*) AS REP_CNT, ART_ID, BRD_ID
		                                                FROM REPLY
		                                                GROUP BY (ART_ID, BRD_ID)
		                                            )USING(BRD_ID, ART_ID)
                                WHERE 	A.ISDELETE = 0
		                       )
		                 WHERE      BRD_ID
		                 BETWEEN	#{brd_id} and #{brd_id}+99
		                 ORDER BY   ART_REGDATE DESC) J)
		WHERE 	RN BETWEEN #{start} and #{end}
	</select>

	
	<!-- 게시판 조회 -->
	<select id="dgArticleList" resultMap="dgArticleMap" parameterType="Article">
		SELECT  *
		FROM    (SELECT ROWNUM AS RN, J.*
		         FROM   (SELECT *
		                 FROM ( SELECT  * 
		                        FROM    ARTICLE A
		                        JOIN    (   SELECT  C1.COMM_VALUE AS BRD_NAME, B.*
		                                    FROM    BOARD B JOIN COMM C1
		                                    ON      BRD_ID IN COMM_ID
		                                )USING(BRD_ID)
		                        JOIN	(   SELECT  C2.COMM_VALUE AS GEN_NAME, M.*
		                                    FROM    MEMBER M JOIN COMM C2
		                                    ON      MEM_GENDER IN COMM_ID
		                                )USING(MEM_ID)
				                LEFT OUTER JOIN 	(   SELECT  C3.COMM_VALUE AS STATUS_NAME, T.*, R.REG_NAME
				                                        FROM    TRADE T LEFT OUTER JOIN COMM C3
				                                        ON      T.TRD_STATUS = C3.COMM_ID
				                                        LEFT OUTER JOIN REGION R
				                                        ON      T.REG_ID = R.REG_ID
				                         )USING(TRD_ID)
		                        LEFT OUTER JOIN    (    SELECT COUNT(*) AS REP_CNT, ART_ID, BRD_ID
		                                                FROM REPLY
		                                                GROUP BY (ART_ID, BRD_ID)
		                                            )USING(BRD_ID, ART_ID)
		                        WHERE 	A.ISDELETE = 0
		                       )
		                 WHERE      BRD_ID = #{brd_id}
		                 ORDER BY   ART_REGDATE DESC) J)
		WHERE 	RN BETWEEN #{start} and #{end}
	</select>
	
	<!-- 게시글 조회 -->
	<select id="dgDetailArticle" resultMap="dgArticleMap" parameterType="Article">
		SELECT  *
		FROM   (SELECT *
		        FROM    ARTICLE A
                JOIN    (   SELECT  C1.COMM_VALUE AS BRD_NAME, B.*
                            FROM    BOARD B JOIN COMM C1
                            ON      BRD_ID IN COMM_ID
                        )USING(BRD_ID)
                JOIN	(   SELECT  C2.COMM_VALUE AS GEN_NAME, M.*
                            FROM    MEMBER M JOIN COMM C2
                            ON      MEM_GENDER IN COMM_ID
                        )USING(MEM_ID)
                LEFT OUTER JOIN 	(   SELECT  C3.COMM_VALUE AS STATUS_NAME, T.*, R.REG_NAME
                                        FROM    TRADE T LEFT OUTER JOIN COMM C3
                                        ON      T.TRD_STATUS = C3.COMM_ID
                                        LEFT OUTER JOIN REGION R
                                        ON      T.REG_ID = R.REG_ID
                         )USING(TRD_ID)
                LEFT OUTER JOIN    (    SELECT COUNT(*) AS REP_CNT, ART_ID, BRD_ID
                                        FROM REPLY
                                        GROUP BY (ART_ID, BRD_ID)
                                    )USING(BRD_ID, ART_ID)
                WHERE 	A.ISDELETE = 0
		        )
		WHERE   ART_ID = #{art_id} AND BRD_ID = #{brd_id}
	</select>

</mapper>